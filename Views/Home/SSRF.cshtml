@{
    ViewData["Title"] = "SSRF Demo";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>@ViewData["Title"]</title>
    <link rel="stylesheet" href="~/css/app.css" />
</head>
<body>

    <h1 style="text-align: center; margin-bottom: 40px;">üß™ SSRF Demo</h1>

    <div class="container">
        <!-- Vulnerable Functionality -->
        <div class="box">
            <h2> An Internal Api endpoint contains sensitive data. Can you fetch it?</h2>
            <form method="POST" asp-controller="Home" asp-action="SSRF">
                <label for="targetUrl">Fetch Url:</label>
                <input type="url" name="targetUrl" id="targetUrl" required>
                <button type="submit">Submit</button>
            </form>
        </div>

        <!-- Secure Coding Challenge -->
        <div class="box">
            <h2>üîê Secure the Code</h2>
            <p>This page is vulnerable to <strong>Server Side Request Forgery (SSRF).</strong></p>
            <p>Your task is to find the line that causes this and fix it.</p>
            <button class="btn btn-outline-dark mt-2" onclick="openCodePopup()">üïµÔ∏è Identify Vulnerability</button>
        </div>
    </div>

    <div style="text-align: center; margin-top: 25px;">
        <h6>Response: @ViewData["Response"]</h6>
    </div>

    <div style="text-align:center; margin-top:24px;">
        <h6>
            Note: In real SSRF, attackers often target services on an internal/private IP.
            For simplicity, this lab hosts a mock internal API on the same server as AspGoat.
        </h6>
    </div>


    <h6 style="margin: 25px;">More Information:</h6>
    <ul>
        <li>
            <a href="https://owasp.org/www-community/attacks/Server_Side_Request_Forgery">OWASP - SSRF</a>
        </li>
        <li>
            <a href="https://portswigger.net/web-security/ssrf">Portswigger - SSRF</a>
        </li>
        <li>
            <a href="https://www.acunetix.com/blog/articles/server-side-request-forgery-vulnerability/">Acunetix - SSRF</a>
        </li>
    </ul>

    <!-- First Modal -->
    <div id="codeModal" class="modal">
        <div class="modal-content">
            <h3>üîç Analyze the Code</h3>
            <div class="popup-line"><input type="checkbox" class="code-checkbox" onchange="checkVulnerability(this, 1)"> public async Task&lt;IActionResult&gt; Fetch(string targetUrl)</div>
            <div class="popup-line"><input type="checkbox" class="code-checkbox" onchange="checkVulnerability(this, 2)"> {</div>
            <div class="popup-line"><input type="checkbox" class="code-checkbox" onchange="checkVulnerability(this, 3)"> &nbsp;&nbsp;using var http = new HttpClient();</div>
            <div class="popup-line"><input type="checkbox" class="code-checkbox" onchange="checkVulnerability(this, 4)"> &nbsp;&nbsp;var response = await http.GetStringAsync(targetUrl);</div>
            <div class="popup-line"><input type="checkbox" class="code-checkbox" onchange="checkVulnerability(this, 5)"> &nbsp;&nbsp;ViewData["Response"] = response;</div>
            <div class="popup-line"><input type="checkbox" class="code-checkbox" onchange="checkVulnerability(this, 6)"> &nbsp;&nbsp;return View();</div>
            <div class="popup-line"><input type="checkbox" class="code-checkbox" onchange="checkVulnerability(this, 7)"> }</div>
            <br />
            <button onclick="closeCodePopup()">Close</button>
        </div>
    </div>

    <!-- Diff Modal -->
    <div id="diffModal" class="diff-modal">
    <div class="diff-content">
        <h3>‚úÖ Secure Version</h3>

        <div class="diff-line removed">- var response = await http.GetStringAsync(targetUrl);</div>

        <div class="diff-line added">+ // Create an allowlist of absolute urls</div>
        <div class="diff-line added">+ var allowedUrls = new HashSet&lt;string&gt;(StringComparer.Ordinal)</div>
        <div class="diff-line added">+ { "https://google.com", "https://facebook.com" };</div>
        <div class="diff-line added">+ if (!allowedUrls.Contains(targetUrl)) return BadRequest("Blocked URL");</div>
        <div class="diff-line added">+ var response = await http.GetStringAsync(targetUrl);</div>

        <br />
        <button onclick="closeDiffPopup()">Close</button>
    </div>
    </div>

    <script src="~/js/ssrf.js"></script>
</body>
</html>
